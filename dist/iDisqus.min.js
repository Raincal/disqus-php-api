!function(e){"use strict";var t,s=document,a=localStorage,o=s.scripts,i=o[o.length-1].src,n=(i.substring(0,i.lastIndexOf("/")),-1<navigator.userAgent.indexOf("Edge")),r=!!window.ActiveXObject||"ActiveXObject"in window;function l(e,t,o){var a=new XMLHttpRequest;return a.open("GET",encodeURI(e)),a.onreadystatechange=function(){4==a.readyState&&200==a.status&&t(a.responseText)},a.onerror=o,a.withCredentials=!0,a.send(),a}function b(e,t,o,a){var i="string"==typeof t?t:Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&"),n=new XMLHttpRequest;return n.open("POST",e),n.onreadystatechange=function(){4==n.readyState&&200==n.status&&o(n.responseText)},n.onerror=a,n.withCredentials=!0,n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(i),n}"function"!=typeof(t=window.Element.prototype).matches&&(t.matches=t.msMatchesSelector||t.mozMatchesSelector||t.webkitMatchesSelector||function(e){for(var t=this,o=(t.document||t.ownerDocument).querySelectorAll(e),a=0;o[a]&&o[a]!==t;)++a;return Boolean(o[a])}),"function"!=typeof t.closest&&(t.closest=function(e){for(var t=this;t&&1===t.nodeType;){if(t.matches(e))return t;t=t.parentNode}return null});var m=function(){this.dom=arguments[0],this.opts=arguments[1],this.init(),this.autologin()};m.prototype={init:function(){var t=this;t.name=a.getItem("name"),t.email=a.getItem("email"),t.url=a.getItem("url"),t.avatar=a.getItem("avatar"),t.type=a.getItem("type"),t.logged_in=a.getItem("logged_in");var e=t.dom.getElementsByClassName("comment-box");"true"==t.logged_in?[].forEach.call(e,function(e){"1"==t.type&&e.querySelector(".comment-form-wrapper").classList.add("logged-in"),e.querySelector(".comment-form-name").value=t.name,e.querySelector(".comment-form-email").value=t.email,e.querySelector(".comment-form-url").value=t.url,e.querySelector(".comment-avatar-image").src=t.avatar}):([].forEach.call(e,function(e){e.querySelector(".comment-form-wrapper").classList.remove("logged-in"),e.querySelector(".comment-form-name").value="",e.querySelector(".comment-form-email").value="",e.querySelector(".comment-form-url").value="",e.querySelector(".comment-avatar-image").src=t.dom.querySelector(".comment-avatar-image").dataset.avatar}),a.setItem("logged_in","false"))},autologin:function(){var o=this;l(o.opts.api+"/user.php",function(e){var t=JSON.parse(e);0==t.code?o.submit(t.response):"1"==o.type&&(a.setItem("logged_in","false"),o.init())},function(){})},login:function(){var t=this,e=window.open(t.opts.api+"/login.php","Disqus Oauth","width=470,height=508");var o=setInterval(function(){e.postMessage("Already logged in?",t.opts.api)},1e3);window.addEventListener("message",function(e){0==e.data.code&&(t.user.submit(e.data.response),clearInterval(o))},!1)},logout:function(){a.setItem("logged_in","false"),b(this.opts.api+"/logout.php",{},function(e){}),this.user.init()},submit:function(e){"0"==e.type&&a.setItem("email",e.email),a.setItem("type",e.type),a.setItem("name",e.name),a.setItem("url",e.url),a.setItem("avatar",e.avatar),a.setItem("logged_in","true"),this.init()}};var c=function(){var t=this;if(t.opts="object"==typeof arguments[1]?arguments[1]:arguments[0],t.dom=s.getElementById("string"==typeof arguments[0]?arguments[0]:"comment"),t.opts.api="/"==t.opts.api.slice(-1)?t.opts.api.slice(0,-1):t.opts.api,t.opts.site=t.opts.site?t.opts.site:location.origin,t.opts.url){var e=t.opts.url.replace(t.opts.site,"");t.opts.url="/"!=e.slice(0,1)?"/"+e:e}else t.opts.url=n||r?encodeURI(location.pathname)+encodeURI(location.search):location.pathname+location.search;t.opts.identifier=t.opts.identifier?t.opts.identifier:t.opts.url,t.opts.link=t.opts.site+t.opts.url,t.opts.title=t.opts.title?t.opts.title:s.title,t.opts.slug=t.opts.slug?t.opts.slug.replace(/[^A-Za-z0-9_-]+/g,""):"",t.opts.desc=t.opts.desc?t.opts.desc:s.querySelector('[name="description"]')?s.querySelector('[name="description"]').content:"",t.opts.mode=t.opts.mode?t.opts.mode:1,t.opts.timeout=t.opts.timeout?t.opts.timeout:3e3,t.opts.toggle=t.opts.toggle?s.getElementById(t.opts.toggle):null,t.opts.badge=t.opts.badge?t.opts.badge:"管理员",t.opts.emoji_path=t.opts.emoji_path?t.opts.emoji_path:"https://assets-cdn.github.com/images/icons/emoji/unicode/",t.emoji_list=t.opts.emoji_list?t.opts.emoji_list:[{code:"smile",title:"笑脸",unicode:"1f604"},{code:"mask",title:"生病",unicode:"1f637"},{code:"joy",title:"破涕为笑",unicode:"1f602"},{code:"stuck_out_tongue_closed_eyes",title:"吐舌",unicode:"1f61d"},{code:"flushed",title:"脸红",unicode:"1f633"},{code:"scream",title:"恐惧",unicode:"1f631"},{code:"pensive",title:"失望",unicode:"1f614"},{code:"unamused",title:"无语",unicode:"1f612"},{code:"grin",title:"露齿笑",unicode:"1f601"},{code:"heart_eyes",title:"色",unicode:"1f60d"},{code:"sweat",title:"汗",unicode:"1f613"},{code:"smirk",title:"得意",unicode:"1f60f"},{code:"relieved",title:"满意",unicode:"1f60c"},{code:"rolling_eyes",title:"翻白眼",unicode:"1f644"},{code:"ok_hand",title:"OK",unicode:"1f44c"},{code:"v",title:"胜利",unicode:"270c"}],t.opts.emoji_preview&&l(t.opts.api+"/eac.min.php",function(e){t.eac=JSON.parse(e)},function(){}),t.stat={current:"idisqus",loaded:!1,loading:!1,editing:!1,offsetTop:0,thread:null,next:null,message:null,mediaHtml:null,root:[],count:0,users:[],imageSize:[],disqusLoaded:!1},window.disqus_config=function(){this.page.identifier=t.opts.identifier,this.page.title=t.opts.title,this.page.url=t.opts.link,this.callbacks.onReady.push(function(){t.stat.current="disqus",t.stat.disqusLoaded=!0,t.dom.querySelector("#idisqus").style.display="none",t.dom.querySelector("#disqus_thread").style.display="block",3==t.opts.mode&&t.opts.toggle&&(t.opts.toggle.disabled="",t.opts.toggle.checked=!0,t.opts.toggle.addEventListener("change",t.handle.toggle,!1))})},t.opts.init&&t.init()};c.prototype.timeAgo=function(){var s={prefix:"",suffix:"前",seconds:"几秒",minute:"1分钟",minutes:"%d分钟",hour:"1小时",hours:"%d小时",day:"1天",days:"%d天",month:"1个月",months:"%d个月",year:"1年",years:"%d年"},r=function(e,t){return s[e]&&s[e].replace(/%d/i,Math.abs(Math.round(t)))},e=function(e){if(e){e=(e=(e=(e=e.replace(/\.\d+/,"")).replace(/-/,"/").replace(/-/,"/")).replace(/T/," ").replace(/Z/," UTC")).replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2"),e=new Date(1e3*e||e);var t=.001*((new Date).getTime()-e)>>0,o=t/60,a=o/60,i=a/24,n=i/365;return s.prefix+(t<45&&r("seconds",t)||t<90&&r("minute",1)||o<45&&r("minutes",o)||o<90&&r("hour",1)||a<24&&r("hours",a)||a<42&&r("day",1)||i<30&&r("days",i)||i<45&&r("month",1)||i<365&&r("months",i/30)||n<1.5&&r("year",1)||r("years",n))+s.suffix}},t=this.dom.querySelectorAll(".comment-item-time");for(var o in t){var a=t[o];"object"==typeof a&&(a.title=new Date(a.getAttribute("datetime")),a.innerHTML=e(a.getAttribute("datetime")))}setTimeout(this.timeAgo.bind(this),6e4)},c.prototype.init=function(){var t=this;if(t.dom){var o="";switch(t.emoji_list.forEach(function(e){o+='<li class="emojione-item" title="'+e.title+'" data-code=":'+e.code+':"><img class="emojione-item-image" src="'+t.opts.emoji_path+e.unicode+'.png" /></li>'}),t.dom.innerHTML='<div class="comment loading" id="idisqus">\n    <div class="loading-container" data-tip="正在加载评论……"><svg class="loading-bg" width="72" height="72" viewBox="0 0 720 720" version="1.1" xmlns="http://www.w3.org/2000/svg"><path class="ring" fill="none" stroke="#9d9ea1" d="M 0 -260 A 260 260 0 1 1 -80 -260" transform="translate(400,400)" stroke-width="50" /><polygon transform="translate(305,20)" points="50,0 0,100 18,145 50,82 92,145 100,100" style="fill:#9d9ea1"/></svg></div>\n    <div class="comment-header"><span class="comment-header-item" id="comment-count">评论</span><a target="_blank" class="comment-header-item" id="comment-link">Disqus 讨论区</a></div>\n    <div class="comment-box">\n        <div class="comment-avatar avatar"><img class="comment-avatar-image" src="https://gravatar.cat.net/avatar/cb85efa6e1ba6fda8790b768d73f2863"></div>\n        <div class="comment-form">\n            <div class="comment-form-wrapper">\n                <textarea class="comment-form-textarea" placeholder="加入讨论……"></textarea>\n                <div class="comment-form-alert"></div>\n                <div class="comment-image">\n                    <ul class="comment-image-list"></ul>\n                    <div class="comment-image-progress">\n                        <div class="comment-image-loaded"></div>\n                    </div>\n                </div>\n                <div class="comment-actions">\n                    <div class="comment-actions-group">\n                        <input id="emoji-input" class="comment-actions-input" type="checkbox"> \n                        <label class="comment-actions-label emojione" for="emoji-input">\n                            <svg class="icon" fill="#c2c6cc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200">\n                                <g>\n                                <title>选择表情</title>\n                                <path d="M512 1024c-282.713043 0-512-229.286957-512-512s229.286957-512 512-512c282.713043 0 512 229.286957 512 512S792.486957 1024 512 1024zM512 44.521739c-258.226087 0-467.478261 209.252174-467.478261 467.478261 0 258.226087 209.252174 467.478261 467.478261 467.478261s467.478261-209.252174 467.478261-467.478261C979.478261 253.773913 768 44.521739 512 44.521739z"></path>\n                                <path d="M801.391304 554.295652c0 160.278261-129.113043 289.391304-289.391304 289.391304s-289.391304-129.113043-289.391304-289.391304L801.391304 554.295652z"></path>\n                                <path d="M674.504348 349.495652m-57.878261 0a2.6 2.6 0 1 0 115.756522 0 2.6 2.6 0 1 0-115.756522 0Z"></path>\n                                <path d="M347.269565 349.495652m-57.878261 0a2.6 2.6 0 1 0 115.756522 0 2.6 2.6 0 1 0-115.756522 0Z"></path>\n                                </g>\n                            </svg>\n                            <ul class="emojione-list">'+o+'</ul>\n                        </label>\n                        <input id="upload-input" class="comment-actions-input comment-image-input" type="file" accept="image/*" name="file"> \n                        <label class="comment-actions-label" for="upload-input">\n                            <svg class="icon" fill="#c2c6cc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200">\n                                <g>\n                                <title>上传图片</title>\n                                <path d="M15.515152 15.515152 15.515152 15.515152 15.515152 15.515152Z"></path>\n                                <path d="M15.515152 139.636364l0 806.787879 992.969697 0 0-806.787879-992.969697 0zM946.424242 884.363636l-868.848485 0 0-682.666667 868.848485 0 0 682.666667zM698.181818 356.848485c0-51.417212 41.673697-93.090909 93.090909-93.090909s93.090909 41.673697 93.090909 93.090909c0 51.417212-41.673697 93.090909-93.090909 93.090909s-93.090909-41.673697-93.090909-93.090909zM884.363636 822.30303l-744.727273 0 186.181818-496.484848 248.242424 310.30303 124.121212-93.090909z"></path>\n                                </g>\n                            </svg>\n                        </label>\n                    </div>\n                    <div class="comment-actions-form">\n                        <label class="comment-actions-label exit" title="退出登录">\n                            <svg class="icon" fill="#c2c6cc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48" height="48">\n                                <path d="M348.870666 210.685443l378.570081 0c32.8205 0 58.683541 26.561959 58.683541 58.683541 0 162.043606 0 324.804551 0 486.848157 0 32.81129-26.561959 58.674331-58.683541 58.674331L348.870666 814.891472c-10.477632 0-18.850323-8.363482-18.850323-18.841114l0-37.728276c0-10.477632 8.372691-18.841114 18.850323-18.841114l343.645664 0c10.477632 0 18.850323-8.372691 18.850323-18.850323L711.366653 304.983109c0-10.477632-8.372691-18.841114-18.850323-18.841114L348.870666 286.141996c-10.477632 0-18.850323-8.363482-18.850323-18.841114l0-37.728276C329.98248 219.095997 338.393034 210.685443 348.870666 210.685443z"></path>\n                                <path d="M128.152728 526.436804l112.450095 112.450095c6.985088 6.985088 19.567661 6.985088 26.552749 0l26.561959-26.561959c6.985088-6.985088 6.985088-19.567661 0-26.552749l-34.925441-34.925441L494.168889 550.84675c10.477632 0 18.850323-8.372691 18.850323-18.850323l0-37.719066c0-10.477632-8.372691-18.850323-18.850323-18.850323L258.754229 475.427036l34.925441-34.925441c6.985088-6.985088 6.985088-19.567661 0-26.552749l-26.561959-26.524097c-6.985088-6.985088-19.567661-6.985088-26.552749 0L128.152728 499.875868C120.431883 506.859933 120.431883 519.451716 128.152728 526.436804z"></path>\n                            </svg>\n                        </label>\n                        <button class="comment-form-submit">\n                            <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200">\n                                <path d="M565.747623 792.837176l260.819261 112.921839 126.910435-845.424882L66.087673 581.973678l232.843092 109.933785 562.612725-511.653099-451.697589 563.616588-5.996574 239.832274L565.747623 792.837176z" fill="#ffffff"></path>\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div class="comment-form-user">'+(1!=t.opts.mode?'<div class="comment-form-auth"><button class="comment-form-login" title="使用 Disqus 帐号登录"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 200 200"><path fill="#2E9FFF" d="M102.535 167.5c-16.518 0-31.621-6.036-43.298-16.021L30.5 155.405l11.102-27.401A67.658 67.658 0 0 1 35.564 100c0-37.277 29.984-67.5 66.971-67.5 36.984 0 66.965 30.223 66.965 67.5 0 37.284-29.98 67.5-66.965 67.5zm36.567-67.693v-.188c0-19.478-13.736-33.367-37.42-33.367h-25.58v67.5h25.201c23.868.001 37.799-14.468 37.799-33.945zm-37.138 17.361h-7.482V82.841h7.482c10.989 0 18.283 6.265 18.283 17.07v.188c0 10.896-7.294 17.069-18.283 17.069z"/></svg></button></div><span> 或 </span>':"")+'<div class="comment-form-guest"><input class="comment-form-input comment-form-name" type="text" placeholder="名字（必填）" autocomplete="name"><input class="comment-form-input comment-form-email" type="email" placeholder="邮箱（必填）" autocomplete="email"><input class="comment-form-input comment-form-url" type="url" placeholder="网址（可选）" autocomplete="url"></div></div>\n        </div>\n    </div>\n    <ul id="comments" class="comment-list"></ul>\n    <a href="javascript:;" class="comment-loadmore">加载更多</a>\n</div>\n<div class="comment" id="disqus_thread"></div>',t.user=new m(t.dom,t.opts),t.box=t.dom.querySelector(".comment-box").outerHTML.replace(/<label class="comment-actions-label exit"(.|\n)*<\/label>\n/,"").replace("comment-form-wrapper","comment-form-wrapper editing").replace(/加入讨论……/,""),t.handle={logout:t.user.logout.bind(t),login:t.user.login.bind(t),loadMore:t.loadMore.bind(t),post:t.post.bind(t),postThread:t.postThread.bind(t),remove:t.remove.bind(t),show:t.show.bind(t),toggle:t.toggle.bind(t),upload:t.upload.bind(t),verify:t.verify.bind(t),jump:t.jump.bind(t),mention:t.mention.bind(t),keySelect:t.keySelect.bind(t),field:t.field,focus:t.focus,input:t.input},t.opts.mode){case 1:t.disqus();break;case 2:t.getlist();break;case 3:t.getlist(),t.disqus();break;default:t.disqus()}}},c.prototype.toggle=function(){var e=this;"disqus"==e.stat.current?(e.stat.current="idisqus",e.dom.querySelector("#idisqus").style.display="block",e.dom.querySelector("#disqus_thread").style.display="none"):e.disqus()},c.prototype.disqus=function(){var e=this;e.dom.querySelector(".loading-container").dataset.tip;if(e.opts.site==location.origin)if(e.stat.disqusLoaded)e.stat.current="disqus",e.dom.querySelector("#idisqus").style.display="none",e.dom.querySelector("#disqus_thread").style.display="block";else{"尝试连接 Disqus……";var t=s.createElement("script");t.src="//"+e.opts.forum+".disqus.com/embed.js",t.dataset.timestamp=Date.now(),t.onload=function(){e.dom.querySelector("#idisqus").style.display="none",e.stat.disqusLoaded=!0,"连接成功，加载 Disqus 评论框……"},t.onerror=function(){1==e.opts.mode&&("连接失败，加载简易评论框……",e.getlist())};var o=new XMLHttpRequest;o.open("GET","//disqus.com/next/config.json?"+Date.now(),!0),o.timeout=e.opts.timeout,o.onreadystatechange=function(){4==o.readyState&&200==o.status&&(s.head||s.body).appendChild(t)},o.ontimeout=function(){o.abort(),1==e.opts.mode&&("连接超时，加载简易评论框……",e.getlist())},o.onerror=function(){1==e.opts.mode&&("连接失败，加载简易评论框……",e.getlist())},o.send()}else 1==e.opts.mode&&e.getlist()},c.prototype.addListener=function(e,t,o){var a=this.dom.getElementsByClassName(e);[].forEach.call(a,function(e){e.addEventListener(t,o,!1)})},c.prototype.removeListener=function(e,t,o){var a=this.dom.getElementsByClassName(e);[].forEach.call(a,function(e){e.removeEventListener(t,o,!1)})},c.prototype.addAllListeners=function(){var e=this;e.addListener("exit","click",e.handle.logout),e.addListener("comment-form-textarea","blur",e.handle.focus),e.addListener("comment-form-textarea","focus",e.handle.focus),e.addListener("comment-form-textarea","input",e.handle.input),e.addListener("comment-form-textarea","keyup",e.handle.mention),e.addListener("comment-form-email","blur",e.handle.verify),e.addListener("comment-form-submit","click",e.handle.post),e.addListener("comment-form-login","click",e.handle.login),e.addListener("comment-image-input","change",e.handle.upload),e.addListener("emojione-item","click",e.handle.field)},c.prototype.count=function(){var i=this,e=s.querySelectorAll("[data-disqus-url]"),t=e.length;if(0<t){for(var o=[],a=0;a<t;a++)o[a]=e[a].dataset.disqusUrl.replace(i.opts.site,"");l(i.opts.api+"/count.php?links="+o.join(","),function(e){JSON.parse(e).response.forEach(function(e){var t=e.link.replace(i.opts.site,""),o="/"!=t.slice(0,1)?"/"+t:t,a=s.querySelector('[data-disqus-url$="'+o+'"]');a&&(a.innerHTML=e.posts,a.dataset.disqusCount=e.posts)})},function(){console.log("获取数据失败！")})}},c.prototype.popular=function(){var i=this;i.opts.popular&&l(i.opts.api+"/popular.php",function(e){var t=JSON.parse(e);if(0==t.code){var o=t.response,a="";o.forEach(function(e){a+='<li><a href="'+e.link.replace(i.opts.site,"")+'" title="'+e.title+'">'+e.title+"</a></li>"}),i.opts.popular.innerHTML=a}},function(){console.log("获取数据失败！")})},c.prototype.getlist=function(){var n=this;n.stat.loading=!0,l(n.opts.api+"/getcomments.php?link="+n.opts.url+(n.stat.next?"&cursor="+n.stat.next:""),function(e){var t=JSON.parse(e);if(0===t.code){n.stat.offsetTop=s.documentElement.scrollTop||s.body.scrollTop,n.stat.thread=t.thread,n.stat.count=t.posts,n.opts.avatar=t.forum.avatar,n.dom.querySelector(".comment-avatar-image").dataset.avatar=t.forum.avatar,"false"==n.user.logged_in&&(n.dom.querySelector(".comment-avatar-image").src=t.forum.avatar),n.opts.badge=t.forum.moderatorBadgeText,n.dom.querySelector("#idisqus").classList.remove("loading"),n.dom.querySelector("#comment-link").href=t.link,n.dom.querySelector("#comment-count").innerHTML=n.stat.count+" 条评论";var o=n.dom.querySelector(".comment-loadmore"),a=t.response?t.response:[];if(n.stat.root=[],a.forEach(function(e){n.load(e),e.parent||n.stat.root.unshift(e.id)}),t.cursor.hasPrev?n.stat.root.forEach(function(e){n.dom.querySelector(".comment-list").appendChild(n.dom.querySelector("#comment-"+e))}):(o.addEventListener("click",n.handle.loadMore,!1),n.addAllListeners()),t.cursor.hasNext?(n.stat.next=t.cursor.next,o.classList.remove("loading")):(n.stat.next=null,o.classList.add("hide")),0==a.length)return;if(window.scrollTo(0,n.stat.offsetTop),n.timeAgo(),/^#disqus|^#comment/.test(location.hash)&&!t.cursor.hasPrev&&!n.stat.disqusLoaded){var i=n.dom.querySelector("#idisqus "+location.hash);window.scrollBy(0,i.getBoundingClientRect().top)}n.stat.loading=!1,n.stat.loaded=!0}else 2===t.code&&n.create()},function(){alert("获取数据失败，请检查服务器设置。")})},c.prototype.load=function(o){var a=this,e=a.dom.querySelector('.comment-item[data-id="'+o.parent+'"]'),t={username:o.username,name:o.name,avatar:o.avatar};o.username&&-1==a.stat.users.map(function(e){return e.username}).indexOf(o.username)&&a.stat.users.push(t);var i=o.parent?{name:'<a class="comment-item-pname" href="#'+e.id+'"><svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M1.664 902.144s97.92-557.888 596.352-557.888V129.728L1024 515.84l-425.984 360.448V628.8c-270.464 0-455.232 23.872-596.352 273.28"></path></svg>'+e.dataset.name+"</a>",dom:e.querySelector(".comment-item-children"),insert:"afterbegin"}:{name:"",dom:a.dom.querySelector(".comment-list"),insert:"preview"==o.id||o.isPost?"afterbegin":"beforeend"},n="";0<o.media.length&&(o.media.forEach(function(e){n+='<a class="comment-item-imagelink" target="_blank" href="'+e+'" ><img class="comment-item-image" src="'+e+'"></a>'}),n='<div class="comment-item-images">'+n+"</div>");var s='<li class="comment-item" data-id="'+o.id+'" data-name="'+o.name+'" id="comment-'+o.id+'"><div class="comment-item-body"><a class="comment-item-avatar" href="#comment-'+o.id+'"><img src="'+o.avatar+'"></a><div class="comment-item-main"><div class="comment-item-header"><a class="comment-item-name" title="'+o.name+'" rel="nofollow" target="_blank" href="'+(o.url?o.url:"javascript:;")+'">'+o.name+"</a>"+(o.isMod?'<span class="comment-item-badge">'+a.opts.badge+"</span>":"")+i.name+'<span class="comment-item-bullet"> • </span><time class="comment-item-time" datetime="'+o.createdAt+'"></time></div><div class="comment-item-content">'+o.message+n+'</div><div class="comment-item-footer">'+(o.isPost?'<span class="comment-item-manage"><a class="comment-item-edit" href="javascript:;">编辑</a><span class="comment-item-bullet"> • </span><a class="comment-item-delete" href="javascript:;">删除</a><span class="comment-item-bullet"> • </span></span>':"")+'<a class="comment-item-reply" href="javascript:;">回复</a> </div></div></div><ul class="comment-item-children"></ul></li>';if(o.isDeleted&&(s='<li class="comment-item" data-id="'+o.id+'" id="comment-'+o.id+'" data-name="已删除"><div class="comment-item-body"><a class="comment-item-avatar" href="#comment-'+o.id+'"><img src="'+o.avatar+'"></a><div class="comment-item-main" data-message="此评论已被删除。"></div></div><ul class="comment-item-children"></ul></li>'),a.dom.querySelector('.comment-item[data-id="'+o.id+'"]')?a.dom.querySelector('.comment-item[data-id="'+o.id+'"]').outerHTML=s:i.dom.insertAdjacentHTML(i.insert,s),o.isDeleted||(a.dom.querySelector('.comment-item[data-id="'+o.id+'"] .comment-item-reply').addEventListener("click",a.handle.show,!1),a.dom.querySelector('.comment-item[data-id="'+o.id+'"] .comment-item-avatar').addEventListener("click",a.handle.jump,!1),o.parent&&a.dom.querySelector('.comment-item[data-id="'+o.id+'"] .comment-item-pname').addEventListener("click",a.handle.jump,!1)),o.isPost&&!a.stat.editing){var r=a.dom.querySelector('.comment-item[data-id="'+o.id+'"]'),l=setTimeout(function(){r.querySelector(".comment-item-manage")&&(r.querySelector(".comment-item-manage").outerHTML="")},6e5);r.querySelector(".comment-item-delete").addEventListener("click",function(e){var t={id:o.id};e.currentTarget.innerHTML="删除中",b(a.opts.api+"/removecomment.php",t,function(e){var t=JSON.parse(e);0===t.code?1==t.response.isDeleted?r.outerHTML="":(alert(t.response.message),r.querySelector(".comment-item-manage").outerHTML=""):2===t.code&&(alert(t.response),r.querySelector(".comment-item-manage").outerHTML="")},function(){alert("删除出错，请稍后重试")}),clearTimeout(l)},!1),r.querySelector(".comment-item-edit").addEventListener("click",function(){a.stat.editing=o,a.edit(o)},!1)}},c.prototype.loadMore=function(e){this.stat.loading||(e.currentTarget.classList.add("loading"),this.getlist())},c.prototype.focus=function(e){var t=e.currentTarget.closest(".comment-form-wrapper");t.classList.add("editing"),t.classList.contains("focus")?t.classList.remove("focus"):t.classList.add("focus")},c.prototype.input=function(e){e.currentTarget.closest(".comment-form").querySelector(".comment-form-alert").innerHTML=""},c.prototype.mention=function(e){var t=this,o=e.currentTarget,a=o.selectionStart,i=o.value.slice(0,a).lastIndexOf("@"),n=o.value.slice(i,a),s=t.dom.querySelector(".mention-user");if(0==n.search(/^@\w+$|^@$/)){if(38==e.keyCode||40==e.keyCode)return;var r=t.stat.users.filter(function(e){var t=new RegExp(n.slice(1),"i");return-1<e.username.search(t)}),l=t.getCaretCoord(o),m="",c="";0<r.length?(r.forEach(function(e,t){m+='<li class="mention-user-item'+(0==t?" active":"")+'" data-username="'+e.username+'"><img class="mention-user-avatar" src="'+e.avatar+'"><div class="mention-user-username">'+e.username+'</div><div class="mention-user-name">'+e.name+"</div></li>"}),s?(s.innerHTML='<ul class="mention-user-list">'+m+"</ul>",s.style.left=l.left+"px",s.style.top=l.top+"px"):(c='<div class="mention-user" style="left:'+l.left+"px;top:"+l.top+'px"><ul class="mention-user-list">'+m+"</ul></div>",t.dom.querySelector("#idisqus").insertAdjacentHTML("beforeend",c)),t.addListener("mention-user-item","mouseover",function(){t.dom.querySelector(".mention-user-item.active").classList.remove("active"),this.classList.add("active")}),t.addListener("mention-user-item","click",function(){var e="@"+this.dataset.username+" ";o.value=o.value.slice(0,i)+e+o.value.slice(a),t.dom.querySelector(".mention-user").outerHTML="",o.focus(),o.setSelectionRange(i+e.length,i+e.length),o.removeEventListener("keydown",t.handle.keySelect,!1)}),o.addEventListener("keydown",t.handle.keySelect,!1)):s&&(s.outerHTML="",o.removeEventListener("keydown",t.handle.keySelect,!1))}else s&&(s.outerHTML="",o.removeEventListener("keydown",t.handle.keySelect,!1))},c.prototype.getCaretCoord=function(e){var t=e.selectionEnd,o=s.createElement("div"),a=s.createElement("span"),i=getComputedStyle(e);[].forEach.call(i,function(e){o.style[e]=i[e]}),o.style.position="absolute",this.dom.appendChild(o),o.textContent=e.value.substr(0,t),a.textContent=e.value.substr(t)||".",o.appendChild(a);var n={top:e.offsetTop-e.scrollTop+a.offsetTop+parseFloat(i.lineHeight),left:e.offsetLeft-e.scrollLeft+a.offsetLeft};return this.dom.removeChild(o),n},c.prototype.keySelect=function(e){var t=e.currentTarget,o=t.selectionStart,a=t.value.slice(0,o).lastIndexOf("@"),i=(t.value.slice(a,o),this.dom.querySelector(".mention-user"),this.dom.querySelector(".mention-user-item.active"));switch(e.keyCode){case 13:var n="@"+i.dataset.username+" ";t.value=t.value.slice(0,a)+n+t.value.slice(o),t.setSelectionRange(a+n.length,a+n.length),this.dom.querySelector(".mention-user").outerHTML="",t.removeEventListener("keydown",this.handle.keySelect,!1),e.preventDefault();break;case 38:i.previousSibling&&(i.previousSibling.classList.add("active"),i.classList.remove("active")),e.preventDefault();break;case 40:i.nextSibling&&(i.nextSibling.classList.add("active"),i.classList.remove("active")),e.preventDefault()}},c.prototype.jump=function(e){var t,o,a=e.currentTarget,i=(t=a.href,o=s.createElement("a"),o.href=t,o).hash,n=this.dom.querySelector("#idisqus "+i);history.replaceState(void 0,void 0,i),window.scrollBy(0,n.getBoundingClientRect().top),e.preventDefault()},c.prototype.field=function(e){var t=e.currentTarget,o=t.closest(".comment-form").querySelector(".comment-form-textarea"),a=o.selectionStart,i=0==a?t.dataset.code+" ":" "+t.dataset.code+" ";o.value=o.value.slice(0,a)+i+o.value.slice(a),o.focus(),o.setSelectionRange(a+i.length,a+i.length)},c.prototype.show=function(e){var t=this,o=e.currentTarget,a=o.closest(".comment-item"),i=t.dom.querySelector(".comment-item .comment-box:not([data-current-id])");if(i){var n=i.closest(".comment-item").querySelector(".comment-item-cancel");n.outerHTML=n.outerHTML.replace("cancel","reply"),i.outerHTML=""}if("comment-item-reply"==o.className){o.outerHTML=o.outerHTML.replace("reply","cancel");var s=t.box.replace(/emoji-input/g,"emoji-input-"+a.dataset.id).replace(/upload-input/g,"upload-input-"+a.dataset.id);a.querySelector(".comment-item-children").insertAdjacentHTML("beforebegin",s),t.user.init(),t.addAllListeners(),a.querySelector(".comment-form-textarea").focus()}t.addListener("comment-item-reply","click",t.handle.show),t.addListener("comment-item-cancel","click",t.handle.show)},c.prototype.verify=function(e){var t=this,o=e.currentTarget.closest(".comment-box"),a=o.querySelector(".comment-avatar-image"),i=o.querySelector(".comment-form-email");o.querySelector(".comment-form-alert");/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(i.value)&&l(t.opts.api+"/getgravatar.php?email="+i.value,function(e){"false"==e?t.errorTips("您所填写的邮箱地址有误。",i):a.src=e},function(){})},c.prototype.upload=function(e){var a=this,t=e.currentTarget,i=t.closest(".comment-form"),o=i.querySelector(".comment-image-progress"),n=i.querySelector(".comment-image-loaded"),s=i.querySelector(".comment-form-wrapper"),r=i.querySelector(".comment-form-alert");if(r.innerHTML="",0!==t.files.length){var l=t.files[0].size;if(5e6<l)return r.innerHTML="请选择 5M 以下图片。",void setTimeout(function(){r.innerHTML=""},3e3);if(-1!=a.stat.imageSize.indexOf(l))return r.innerHTML="请勿选择已存在的图片。",void setTimeout(function(){r.innerHTML=""},3e3);o.style.width="80px",s.classList.add("expanded");var m=new FormData;m.append("file",t.files[0]);var c,d=t.files[0].name,u=new XMLHttpRequest;u.onreadystatechange=function(){if(4==u.readyState&&200==u.status){var e=JSON.parse(u.responseText);if(0==e.code){a.stat.imageSize.push(l);var t=e.response[d].url,o=new Image;o.src=t,o.onload=function(){c.innerHTML='<img class="comment-image-object" src="'+t+'">',c.dataset.imageUrl=t,c.classList.remove("loading"),c.addEventListener("click",a.handle.remove,!1)}}else r.innerHTML="图片上传出错。",c.innerHTML="",i.getElementsByClassName("comment-image-item").length&&s.classList.remove("expanded"),setTimeout(function(){r.innerHTML=""},3e3)}},u.upload.addEventListener("progress",function(e){n.style.width=Math.ceil(e.loaded/e.total*100)+"%"},!1),u.upload.addEventListener("load",function(e){n.style.width=0,o.style.width=0;var t='<li class="comment-image-item loading" data-image-size="'+l+'">\n    <svg version="1.1" class="comment-image-object" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n        width="24px" height="30px" viewBox="0 0 24 30" style="enable-background: new 0 0 50 50;" xml:space="preserve">\n        <rect x="0" y="10" width="4" height="10" fill="rgba(127,145,158,1)" opacity="0.2">\n            <animate attributeName="opacity" attributeType="XML" values="0.2; 1; .2" begin="0s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="height" attributeType="XML" values="10; 20; 10" begin="0s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="y" attributeType="XML" values="10; 5; 10" begin="0s" dur="0.6s" repeatCount="indefinite" />\n        </rect>\n        <rect x="8" y="10" width="4" height="10" fill="rgba(127,145,158,1)" opacity="0.2">\n            <animate attributeName="opacity" attributeType="XML" values="0.2; 1; .2" begin="0.15s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="height" attributeType="XML" values="10; 20; 10" begin="0.15s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="y" attributeType="XML" values="10; 5; 10" begin="0.15s" dur="0.6s" repeatCount="indefinite" />\n        </rect>\n        <rect x="16" y="10" width="4" height="10" fill="rgba(127,145,158,1)" opacity="0.2">\n            <animate attributeName="opacity" attributeType="XML" values="0.2; 1; .2" begin="0.3s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="height" attributeType="XML" values="10; 20; 10" begin="0.3s" dur="0.6s" repeatCount="indefinite" />\n            <animate attributeName="y" attributeType="XML" values="10; 5; 10" begin="0.3s" dur="0.6s" repeatCount="indefinite" />\n        </rect>\n    </svg>\n</li>\n';i.querySelector(".comment-image-list").insertAdjacentHTML("beforeend",t),c=i.querySelector('[data-image-size="'+l+'"]')},!1),u.open("POST",a.opts.api+"/upload.php",!0),u.send(m)}},c.prototype.remove=function(e){var o=this,t=e.currentTarget.closest(".comment-image-item"),a=e.currentTarget.closest(".comment-form-wrapper");t.outerHTML="",o.stat.imageSize=[];var i=a.getElementsByClassName("comment-image-item");[].forEach.call(i,function(e,t){o.stat.imageSize[t]=e.dataset.imageSize}),0==o.stat.imageSize.length&&a.classList.remove("expanded"),a.querySelector(".comment-image-input").value=""},c.prototype.errorTips=function(e,t){var o=this;"true"==o.user.logged_in&&o.handle.logout();var a=o.dom.querySelector("#idisqus"),i=o.dom.querySelector(".comment-form-error");i&&(i.outerHTML="");var n='<div class="comment-form-error" style="top:'+t.offsetTop+"px;left:"+t.offsetLeft+'px;">'+e+"</div>";a.insertAdjacentHTML("beforeend",n),setTimeout(function(){var e=o.dom.querySelector(".comment-form-error");e&&(e.outerHTML="")},3e3)},c.prototype.post=function(e){var a=this,i=e.currentTarget.closest(".comment-box[data-current-id]")||e.currentTarget.closest(".comment-item")||e.currentTarget.closest(".comment-box"),t=i.querySelector(".comment-form-textarea").value,o=i.dataset.id?i.dataset.id:"",n=i.getElementsByClassName("comment-image-item"),s=[],r="";if([].forEach.call(n,function(e,t){s[t]=e.dataset.imageUrl,r+=" "+e.dataset.imageUrl}),!i.dataset.currentId){var l=i.querySelector(".comment-form-name"),m=i.querySelector(".comment-form-email"),c=i.querySelector(".comment-form-url"),d={name:l.value,email:m.value,url:c.value.replace(/\s/g,""),avatar:i.querySelector(".comment-avatar-image").src,type:0},u=i.querySelector(".comment-form-alert"),p=function(){setTimeout(function(){u.innerHTML=""},3e3)};if("1"!=a.user.type){if(/^\s*$/i.test(d.name))return void a.errorTips("名字不能为空。",l);if(/^\s*$/i.test(d.email))return void a.errorTips("邮箱不能为空。",m);if(!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(d.email))return void a.errorTips("请正确填写邮箱。",m);if(!/^([hH][tT]{2}[pP]:\/\/|[hH][tT]{2}[pP][sS]:\/\/)(([A-Za-z0-9-~]+)\.)+([A-Za-z0-9-~\/])+$|^\s*$/i.test(d.url))return void a.errorTips("请正确填写网址。",c);if(a.user.submit(d),!a.user.name&&!a.user.email)return}if(a.stat.message||a.stat.mediaHtml||(a.box=a.dom.querySelector(".comment-box").outerHTML.replace(/<label class="comment-actions-label exit"(.|\n)*<\/label>\n/,"").replace("comment-form-wrapper","comment-form-wrapper editing").replace(/加入讨论……/,"")),0==s.length&&/^\s*$/i.test(t))return u.innerHTML="评论不能为空或空格。",void i.querySelector(".comment-form-textarea").focus();var f=t;a.opts.emoji_preview?f=f.replace(/:([-+\w]+):/g,function(e){var t=e.replace(/:/g,"");return a.eac[t]?'<img class="emojione" width="24" height="24" alt="'+t+'" title=":'+t+':" src="'+a.opts.emoji_path+a.eac[t]+'.png">':e}):a.emoji_list.forEach(function(e){f=f.replace(":"+e.code+":",'<img class="emojione" width="24" height="24" src="'+a.opts.emoji_path+e.unicode+'.png" />')});var g={url:a.user.url?a.user.url:"",isMod:!1,username:null,name:a.user.name,avatar:a.user.avatar,id:"preview",parent:o,createdAt:(new Date).toJSON(),message:"<p>"+f+"</p>",media:s};a.load(g),a.timeAgo(),a.stat.message=t,a.stat.mediaHtml=i.querySelector(".comment-image-list").innerHTML,o?i.querySelector(".comment-item-cancel").click():(i.querySelector(".comment-form-textarea").value="",i.querySelector(".comment-image-list").innerHTML="",i.querySelector(".comment-form-wrapper").classList.remove("expanded","editing"))}var v=t.match(/@\w+/g);if(v&&0<(v=v.filter(function(e){return-1<a.stat.users.map(function(e){return e.username}).indexOf(e.slice(1))})).length){var h=new RegExp("("+v.join("|")+")","g");t=t.replace(h,"$1:disqus")}if(t+=r,i.dataset.currentId){var y={id:i.dataset.currentId,message:t};b(a.opts.api+"/updatecomment.php",y,function(e){var t=JSON.parse(e);if(0===t.code){a.stat.message=null,a.stat.mediaHtml=null;var o=t.response;a.load(o),a.timeAgo(),a.stat.editing=!1}else a.load(a.stat.editing),a.timeAgo(),a.stat.editing=!1},function(){a.load(a.stat.editing),a.timeAgo(),a.stat.editing=!1})}else{y={thread:a.stat.thread,parent:o,message:t,name:a.user.name,email:a.user.email,url:a.user.url,link:a.opts.url,title:a.opts.title};b(a.opts.api+"/postcomment.php",y,function(e){var t=JSON.parse(e);if(0===t.code){a.dom.querySelector('.comment-item[data-id="preview"]').outerHTML="",a.stat.count+=1,a.dom.querySelector("#comment-count").innerHTML=a.stat.count+" 条评论";var o=t.response;o.isPost=!0,a.load(o),a.timeAgo()}else 2===t.code&&(u.innerHTML=t.response,a.dom.querySelector('.comment-item[data-id="preview"]').outerHTML="",a.reEdit(i),-1<t.response.indexOf("author")&&a.handle.logout())},function(){u.innerHTML="提交出错，请稍后重试。",p(),a.dom.querySelector('.comment-item[data-id="preview"]').outerHTML="",a.reEdit(i)})}},c.prototype.reEdit=function(e){var t=this;e.dataset.id?e.querySelector(".comment-item-reply").click():e.querySelector(".comment-form-wrapper").classList.add("editing"),t.stat.message&&(e.querySelector(".comment-form-textarea").value=t.stat.message),t.stat.mediaHtml&&(e.querySelector(".comment-form-wrapper").classList.add("expanded"),e.querySelector(".comment-image-list").innerHTML=t.stat.mediaHtml,t.addListener("comment-image-item","click",t.handle.remove))},c.prototype.edit=function(e){var t=this,o=t.box.replace("comment-box","comment-box comment-box-"+e.id).replace(/emoji-input/g,"emoji-input-"+e.id).replace(/upload-input/g,"upload-input-"+e.id);t.dom.querySelector('.comment-item[data-id="'+e.id+'"] .comment-item-body').outerHTML=o,t.user.init();var a=t.dom.querySelector(".comment-box-"+e.id);a.dataset.currentId=e.id,t.addAllListeners(),a.querySelector(".comment-form-textarea").focus(),a.querySelector(".comment-actions-form").insertAdjacentHTML("afterbegin",'<a class="comment-form-cancel" href="javascript:;">取消</a>'),a.querySelector(".comment-form-cancel").addEventListener("click",function(){t.stat.editing=!1,t.load(e),t.timeAgo()},!1),t.stat.message&&(a.querySelector(".comment-form-textarea").value=t.stat.message),t.stat.mediaHtml&&(a.querySelector(".comment-form-wrapper").classList.add("expanded"),a.querySelector(".comment-image-list").innerHTML=t.stat.mediaHtml,t.addListener("comment-image-item","click",t.handle.remove))},c.prototype.create=function(){var e=this;if(e.opts.auto){e.dom.querySelector(".loading-container").dataset.tip="正在创建 Thread……";var t={url:e.opts.link,identifier:e.opts.identifier,title:e.opts.title,slug:e.opts.slug,message:e.opts.desc};e.postThread(t)}else e.dom.querySelector("#idisqus").classList.remove("loading"),e.dom.querySelector("#idisqus").innerHTML='<div class="comment-header"><span class="comment-header-item">创建 Thread</span></div><div class="comment-thread-form"><p>由于 Disqus 没有本页面的相关 Thread，故需先创建 Thread</p><div class="comment-form-item"><label class="comment-form-label">url:</label><input class="comment-form-input" id="thread-url" name="url" value="'+e.opts.link+'" disabled /></div><div class="comment-form-item"><label class="comment-form-label">identifier:</label><input class="comment-form-input" id="thread-identifier" name="identifier" value="'+e.opts.identifier+'" disabled /></div><div class="comment-form-item"><label class="comment-form-label">title:</label><input class="comment-form-input" id="thread-title" name="title" value="'+e.opts.title+'" disabled /></div><div class="comment-form-item"><label class="comment-form-label">slug:</label><input class="comment-form-input" id="thread-slug" name="slug" value="'+e.opts.slug+'" /></div><div class="comment-form-item"><label class="comment-form-label">message:</label><textarea class="comment-form-textarea" id="thread-message" name="message">'+e.opts.desc+'</textarea></div><button id="thread-submit" class="comment-form-submit">提交</button></div>',e.dom.querySelector("#thread-submit").addEventListener("click",e.handle.postThread,!1)},c.prototype.postThread=function(){var e=this;if(arguments[0].target)var t={url:e.dom.querySelector("#thread-url").value,identifier:e.dom.querySelector("#thread-identifier").value,title:e.dom.querySelector("#thread-title").value,slug:e.dom.querySelector("#thread-slug").value.replace(/[^A-Za-z0-9_-]+/g,""),message:e.dom.querySelector("#thread-message").value};else t=arguments[0];b(e.opts.api+"/createthread.php",t,function(e){var t=JSON.parse(e);if(0!==t.code)return 2===t.code?-1<t.response.indexOf("A thread already exists with link")?void alert(t.response.replace("A thread already exists with link,","已存在此链接的相关 Thread，")):-1<t.response.indexOf("Invalid URL")?void alert("参数错误，无效的'URL'"):-1<t.response.indexOf("Invalid slug")?void alert("参数错误，无效的'slug'"):void alert(t.response):void alert(t.response);alert("创建 Thread 成功，刷新后便可愉快地评论了！"),setTimeout(function(){location.reload()},2e3)},function(){alert("创建 Thread 出错，请稍后重试！")})},c.prototype.destroy=function(){var e=this;e.removeListener("exit","click",e.handle.logout),e.removeListener("comment-form-textarea","blur",e.handle.focus),e.removeListener("comment-form-textarea","focus",e.handle.focus),e.removeListener("comment-form-textarea","keyup",e.handle.mention),e.removeListener("comment-form-email","blur",e.handle.verify),e.removeListener("comment-form-submit","click",e.handle.post),e.removeListener("comment-image-input","change",e.handle.upload),e.removeListener("comment-item-reply","click",e.handle.show),e.removeListener("comment-loadmore","click",e.handle.loadMore),e.removeListener("emojione-item","click",e.handle.field),e.dom.innerHTML="",delete e.box,delete e.dom,delete e.emoji_list,delete e.user,delete e.handle,delete e.opts,delete e.stat},"function"==typeof require&&"object"==typeof module&&module&&"object"==typeof exports&&exports?module.exports=c:"function"==typeof define&&define.amd?define(function(){return c}):e.iDisqus=e.iDisqus||c}(window||this);